<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TacBoard / Game Dream</title>
    <style>
        :root {
            --bg: #0f172a;
            --court-bg: #1e293b;
            --lines: #94a3b8;
            --paint-bg: rgba(148, 163, 184, 0.08);
            --accent: #f472b6;
            --team-a: #ffffff;
            --team-b: #0f172a;
            --team-b-border: #94a3b8;
            --ball: #f97316;
            --timeline-bg: rgba(30, 41, 59, 0.9);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            font-family: 'Inter', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –Ω–∞ iOS/Android */
            touch-action: none;
            /* –ó–∞–ø—Ä–µ—Ç –ø–∏–Ω—á-–∑—É–º–∞ –∏ —Å–∫—Ä–æ–ª–ª–∞ */
        }

        header {
            padding: 1rem;
            text-align: center;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
        }

        header h1 {
            font-size: 1.2rem;
            background: linear-gradient(to right, #818cf8, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .board-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            /* –£–±—Ä–∞–ª –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ */
            position: relative;
            background: var(--court-bg);
            min-height: 0;
            /* –§–∏–∫—Å –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã max-height –≤–æ flexbox */
            touch-action: none;
        }

        #board {
            background-color: var(--court-bg);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            touch-action: none;
        }

        #court-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .entity {
            position: absolute;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: grab;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: left 1.5s ease-in-out, top 1.5s ease-in-out, transform 0.1s;
            z-index: 100;
            transform: translate(-50%, -50%);
        }

        .entity.dragging {
            transition: none !important;
            /* –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
        }

        .entity:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.15);
            z-index: 1000 !important;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }

        .team-a {
            background: var(--team-a);
            color: var(--team-b);
            border: 2px solid #ccc;
        }

        .team-b {
            background: var(--team-b);
            color: var(--team-a);
            border: 2px solid var(--team-b-border);
        }

        .ball {
            width: 22px;
            height: 22px;
            background: var(--ball);
            border: 1px solid #7c2d12;
            background-image: radial-gradient(circle at 30% 30%, #fb923c, #ea580c);
            z-index: 110;
            font-size: 0;
        }

        .toolbar {
            padding: 1rem;
            background: var(--timeline-bg);
            display: flex;
            justify-content: space-around;
            gap: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-info {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .timeline-info.visible {
            opacity: 1;
        }

        button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 10px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        button:active {
            transform: scale(0.95);
        }

        button.primary {
            background: #818cf8;
            color: white;
            border: none;
        }

        button.primary:hover {
            background: #6366f1;
        }

        button.play-btn {
            background: #10b981;
            color: white;
            border: none;
        }

        button.play-btn:hover {
            background: #059669;
        }

        button.play-btn:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
        }

        .timeline-dots {
            display: flex;
            gap: 5px;
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: background 0.3s;
        }

        .dot.active {
            background: #f472b6;
            box-shadow: 0 0 5px #f472b6;
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–æ–∫ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ --- */
        .secondary {
            border-top: none;
            padding-top: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--court-bg);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            outline: none;
            font-size: 1rem;
        }

        .combo-list {
            max-height: 250px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .combo-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s;
        }

        .combo-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .combo-title {
            font-weight: bold;
            font-size: 0.95rem;
        }

        .combo-author {
            font-size: 0.75rem;
            color: var(--lines);
            margin-top: 4px;
        }
    </style>
</head>

<body>

    <header>
        <h1>TacBoard</h1>
    </header>

    <div class="board-container">
        <div id="board">
            <svg id="court-svg" viewBox="0 0 150 140" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="0" y="0" width="150" height="140" fill="none" class="court-line" />
                <rect x="50.5" y="0" width="49" height="58" fill="var(--paint-bg)" class="court-line" />
                <path d="M 57 58 A 18 18 0 0 0 93 58" fill="none" class="court-line" />
                <path d="M 57 58 A 18 18 0 0 1 93 58" fill="none" class="court-line court-dashed" />
                <line x1="9" y1="0" x2="9" y2="30" class="court-line" />
                <line x1="141" y1="0" x2="141" y2="30" class="court-line" />
                <path d="M 9 30 A 67.5 67.5 0 0 0 141 30" fill="none" class="court-line" />
                <line x1="66" y1="12" x2="84" y2="12" stroke="var(--accent)" stroke-width="2" />
                <circle cx="75" cy="15.75" r="2.25" fill="none" stroke="var(--ball)" stroke-width="1.2" />
                <path d="M 62.5 15.75 A 12.5 12.5 0 0 0 87.5 15.75" fill="none" class="court-line" />

                <style>
                    .court-line {
                        stroke: var(--lines);
                        stroke-width: 1.5;
                        vector-effect: non-scaling-stroke;
                    }

                    .court-dashed {
                        stroke-dasharray: 4, 3;
                    }
                </style>
            </svg>
        </div>
        <div class="timeline-dots" id="dotsContainer"></div>
        <div class="timeline-info" id="timelineInfo">–ö–∞–¥—Ä 1/1</div>
    </div>

    <div class="toolbar">
        <button id="resetBtn">–°–±—Ä–æ—Å</button>
        <button id="saveBtn" class="primary">üìå –®–∞–≥</button>
        <button id="playBtn" class="play-btn" disabled>‚ñ∂Ô∏è –ü–ª–µ–π</button>
    </div>
    <div class="toolbar secondary">
        <button id="saveCloudBtn" style="background: rgba(139, 92, 246, 0.8);">‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è –∫–æ–º–∞–Ω–¥—ã</button>
        <button id="loadCloudBtn" style="background: rgba(59, 130, 246, 0.8);">üìÇ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∏ -->
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é</h3>
            <input type="text" id="comboName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ü–∏–∫-–Ω-—Ä–æ–ª–ª)">
            <div style="display: flex; gap: 10px;">
                <button id="confirmSaveBtn" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="document.getElementById('saveModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="loadModal" class="modal">
        <div class="modal-content">
            <h3>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–æ–º–∞–Ω–¥—ã</h3>
            <div id="comboList" class="combo-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button onclick="document.getElementById('loadModal').style.display='none'"
                style="width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Telegram Mini App Initialization
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        if (tg.disableVerticalSwipes) tg.disableVerticalSwipes(); // –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∂–µ—Å—Ç —Å–≤–∞–π–ø–∞ –≤–Ω–∏–∑ –¢–ì

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ª—é–±—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑—É–º—ã –∏ —Å–∫—Ä–æ–ª–ª—ã –ø–æ –≤—Å–µ–π –¥–æ—Å–∫–µ
        document.querySelector('.board-container').addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        tg.ready();  // –°–æ–æ–±—â–∞–µ–º —Ç–µ–ª–µ–≥—Ä–∞–º—É, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã Telegram (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if (tg.themeParams.bg_color) {
            document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color);
        }

        const board = document.getElementById('board');
        const playBtn = document.getElementById('playBtn');
        const dotsContainer = document.getElementById('dotsContainer');
        const timelineInfo = document.getElementById('timelineInfo');

        const startPositions = {
            teamA: [ // –°–≤–µ—Ç–ª—ã–µ (–Ω–∞–ø–∞–¥–µ–Ω–∏–µ)
                { id: 'a1', num: 1, x: 50, y: 62 }, { id: 'a2', num: 2, x: 85, y: 50 },
                { id: 'a3', num: 3, x: 15, y: 50 }, { id: 'a4', num: 4, x: 70, y: 15 },
                { id: 'a5', num: 5, x: 30, y: 15 }
            ],
            ball: { id: 'ball', x: 52, y: 65 }
        };

        let frames = []; // –ú–∞—Å—Å–∏–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤
        let isPlaying = false;

        function createEntity(data, className) {
            const el = document.createElement('div');
            el.className = `entity ${className}`;
            el.id = data.id;
            if (data.num && !className.includes('ball')) el.innerText = data.num;

            el.style.left = `${data.x}%`;
            el.style.top = `${data.y}%`;

            board.appendChild(el);
            return el;
        }

        // --- –ü–æ–¥–≥–æ–Ω–∫–∞ –¥–æ—Å–∫–∏ –ø–æ —ç–∫—Ä–∞–Ω—É ---
        function resizeBoard() {
            const container = document.querySelector('.board-container');
            const cWidth = container.clientWidth;
            const cHeight = container.clientHeight;

            const targetRatio = 15 / 14;
            const containerRatio = cWidth / cHeight;

            if (containerRatio > targetRatio) {
                // –≠–∫—Ä–∞–Ω —à–∏—Ä–µ, —á–µ–º –Ω—É–∂–Ω–æ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è) -> —É–ø–∏—Ä–∞–µ–º—Å—è –≤ –≤—ã—Å–æ—Ç—É
                board.style.height = `${cHeight}px`;
                board.style.width = `${cHeight * targetRatio}px`;
            } else {
                // –≠–∫—Ä–∞–Ω –≤—ã—à–µ, —á–µ–º –Ω—É–∂–Ω–æ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è) -> —É–ø–∏—Ä–∞–µ–º—Å—è –≤ —à–∏—Ä–∏–Ω—É
                board.style.width = `${cWidth}px`;
                board.style.height = `${cWidth / targetRatio}px`;
            }
        }
        window.addEventListener('resize', resizeBoard);
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        resizeBoard();
        // –í Telegram –∏–Ω–æ–≥–¥–∞ –≤—ã—Å–æ—Ç–∞ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, –ø–æ—ç—Ç–æ–º—É –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –µ—â–µ –æ–¥–∏–Ω –≤—ã–∑–æ–≤
        setTimeout(resizeBoard, 100);

        function initBoard() {
            document.querySelectorAll('.entity').forEach(el => el.remove());
            startPositions.teamA.forEach(p => createEntity(p, 'team-a'));
            createEntity(startPositions.ball, 'ball');

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–ª–∞–π–Ω
            saveCurrentStateAsFrame(true);
        }

        // --- –¢–∞–π–º–ª–∞–π–Ω –õ–æ–≥–∏–∫–∞ ---

        function getCurrentState() {
            const state = [];
            document.querySelectorAll('.entity').forEach(el => {
                state.push({
                    id: el.id,
                    x: parseFloat(el.style.left),
                    y: parseFloat(el.style.top)
                });
            });
            return state;
        }

        function saveCurrentStateAsFrame(isReset = false) {
            if (isReset) {
                frames = [];
            }
            frames.push(getCurrentState());
            updateUI();
        }

        function renderDots() {
            dotsContainer.innerHTML = '';
            frames.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `dot ${i === frames.length - 1 ? 'active' : ''}`;
                dotsContainer.appendChild(dot);
            });
        }

        function updateUI() {
            renderDots();
            playBtn.disabled = frames.length <= 1;
            timelineInfo.innerText = `–ö–∞–¥—Ä ${frames.length}/${frames.length}`;
            timelineInfo.classList.add('visible');
            setTimeout(() => timelineInfo.classList.remove('visible'), 2000);
        }

        function applyFrame(frameIndex) {
            if (!frames[frameIndex]) return;
            const state = frames[frameIndex];

            state.forEach(data => {
                const el = document.getElementById(data.id);
                if (el) {
                    el.style.left = `${data.x}%`;
                    el.style.top = `${data.y}%`;
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏
            document.querySelectorAll('.dot').forEach((dot, i) => {
                dot.className = `dot ${i === frameIndex ? 'active' : ''}`;
            });
            timelineInfo.innerText = `–ö–∞–¥—Ä ${frameIndex + 1}/${frames.length}`;
            timelineInfo.classList.add('visible');
        }

        async function playTimeline() {
            if (frames.length <= 1 || isPlaying) return;
            isPlaying = true;

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –Ω–∞—á–∞–ª–æ –±–µ–∑ –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            document.querySelectorAll('.entity').forEach(el => el.classList.add('dragging'));
            applyFrame(0);

            // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
            await new Promise(r => setTimeout(r, 50));
            document.querySelectorAll('.entity').forEach(el => el.classList.remove('dragging'));

            // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∫–∞–¥—Ä—ã
            for (let i = 1; i < frames.length; i++) {
                await new Promise(r => setTimeout(r, 1600)); // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ (—á—É—Ç—å –±–æ–ª—å—à–µ CSS —Ç—Ä–∞–Ω–∑–∏—Ü–∏–∏)
                applyFrame(i);
            }

            setTimeout(() => {
                isPlaying = false;
                timelineInfo.classList.remove('visible');
            }, 1000);
        }

        // --- Drag and Drop ---
        let activeEntity = null;

        board.addEventListener('pointerdown', (e) => {
            if (e.cancelable) e.preventDefault(); // –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é

            if (isPlaying) return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è
            const target = e.target.closest('.entity');
            if (!target) return;

            activeEntity = target;
            activeEntity.style.zIndex = 1000;
            activeEntity.classList.add('dragging'); // –û—Ç–∫–ª—é—á–∞–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç—å CSS –ø—Ä–∏ –¥—Ä–∞–≥–µ

            // –ï—Å–ª–∏ –ø–æ—Ç—è–Ω—É–ª–∏ –∑–∞ –∏–≥—Ä–æ–∫–∞, –ø—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ —Ä—è–¥–æ–º —Å –Ω–∏–º –º—è—á
            if (activeEntity.id !== 'ball') {
                const ball = document.getElementById('ball');
                if (ball) {
                    const pX = parseFloat(activeEntity.style.left);
                    const pY = parseFloat(activeEntity.style.top);
                    const bX = parseFloat(ball.style.left);
                    const bY = parseFloat(ball.style.top);

                    const dist = Math.hypot(pX - bX, pY - bY);
                    if (dist <= 7) { // –ü–æ—Ä–æ–≥ "–ø—Ä–∏–ª–∏–ø–∞–Ω–∏—è" ~7% –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
                        activeEntity.hasBall = true;
                        activeEntity.ballOffsetX = bX - pX;
                        activeEntity.ballOffsetY = bY - pY;
                        ball.classList.add('dragging'); // –û—Ç–∫–ª—é—á–∞–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∏ –¥–ª—è –º—è—á–∞
                    } else {
                        activeEntity.hasBall = false;
                    }
                }
            }
        }, { passive: false });

        document.addEventListener('pointermove', (e) => {
            if (!activeEntity || isPlaying) return;
            if (e.cancelable) e.preventDefault(); // –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ –≤–µ–¥–µ–Ω–∏–∏ –ø–∞–ª—å—Ü–µ–º

            const boardRect = board.getBoundingClientRect();
            let x = e.clientX - boardRect.left;
            let y = e.clientY - boardRect.top;

            x = Math.max(0, Math.min(x, boardRect.width));
            y = Math.max(0, Math.min(y, boardRect.height));

            const pctX = (x / boardRect.width) * 100;
            const pctY = (y / boardRect.height) * 100;

            activeEntity.style.left = `${pctX}%`;
            activeEntity.style.top = `${pctY}%`;

            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ "–≤–ª–∞–¥–µ–µ—Ç" –º—è—á–æ–º, –¥–≤–∏–≥–∞–µ–º –º—è—á–∏–∫ –≤–º–µ—Å—Ç–µ —Å –Ω–∏–º
            if (activeEntity.hasBall) {
                const ball = document.getElementById('ball');
                if (ball) {
                    ball.style.left = `${pctX + activeEntity.ballOffsetX}%`;
                    ball.style.top = `${pctY + activeEntity.ballOffsetY}%`;
                }
            }
        });

        document.addEventListener('pointerup', () => {
            if (activeEntity) {
                activeEntity.style.zIndex = activeEntity.classList.contains('ball') ? 110 : 100;
                activeEntity.classList.remove('dragging');

                if (activeEntity.hasBall) {
                    const ball = document.getElementById('ball');
                    if (ball) ball.classList.remove('dragging');
                    activeEntity.hasBall = false;
                }

                activeEntity = null;
            }
        });

        // --- –°–ª—É—à–∞—Ç–µ–ª–∏ ---
        document.getElementById('resetBtn').addEventListener('click', initBoard);

        document.getElementById('saveBtn').addEventListener('click', () => {
            if (isPlaying) return;
            saveCurrentStateAsFrame();

            const btn = document.getElementById('saveBtn');
            btn.style.background = '#10b981';
            setTimeout(() => btn.style.background = '', 500);
        });

        document.getElementById('playBtn').addEventListener('click', playTimeline);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        initBoard();

        // --- –û–±–ª–∞—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ë–î) ---
        const LOCAL_API_URL = 'http://localhost:3000/api/combos';
        const REMOTE_API_URL = 'https://combo-board-server.onrender.com/api/combos';

        const saveCloudBtn = document.getElementById('saveCloudBtn');
        const loadCloudBtn = document.getElementById('loadCloudBtn');
        const saveModal = document.getElementById('saveModal');
        const loadModal = document.getElementById('loadModal');
        const comboNameInput = document.getElementById('comboName');
        const comboListDiv = document.getElementById('comboList');

        saveCloudBtn.addEventListener('click', () => {
            if (frames.length <= 1) return alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ä–∏—Å—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–≥ –Ω–∞ –¥–æ—Å–∫–µ (–∫–Ω–æ–ø–∫–∞ üìå –®–∞–≥)!');
            saveModal.style.display = 'flex';
        });

        loadCloudBtn.addEventListener('click', async () => {
            loadModal.style.display = 'flex';
            comboListDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π...';

            // –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å file://, —Å—Ç—É—á–∏–º—Å—è –∫ localhost. 
            // –ò–Ω–∞—á–µ (–∫–æ–≥–¥–∞ –∑–∞–¥–µ–ø–ª–æ–∏–º –Ω–∞ Render) –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
            const fetchUrl = window.location.protocol === 'file:' ? LOCAL_API_URL : REMOTE_API_URL;

            try {
                const res = await fetch(fetchUrl);
                const data = await res.json();

                if (data.success) {
                    comboListDiv.innerHTML = '';
                    if (data.combos.length === 0) {
                        comboListDiv.innerHTML = '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞.';
                        return;
                    }
                    data.combos.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'combo-item';

                        const infoDiv = document.createElement('div');
                        infoDiv.style.flex = "1";
                        infoDiv.innerHTML = `<div class="combo-title">${c.name}</div><div class="combo-author">–û—Ç: ${c.author}</div>`;
                        infoDiv.onclick = () => {
                            frames = c.frames;
                            updateUI();
                            loadModal.style.display = 'none';
                            applyFrame(0); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ–∑–∏—Ü–∏—é –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
                        };

                        const delBtn = document.createElement('div');
                        delBtn.innerHTML = 'üóëÔ∏è';
                        delBtn.style.padding = '0 10px';
                        delBtn.style.fontSize = '1.2rem';
                        delBtn.onclick = async (e) => {
                            e.stopPropagation(); // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–æ—Ä–∑–∏–Ω—É

                            const executeDelete = async () => {
                                try {
                                    const delRes = await fetch(`${fetchUrl}/${c._id}`, { method: 'DELETE' });
                                    const delData = await delRes.json();
                                    if (delData.success) {
                                        div.remove();
                                    } else {
                                        if (tg && tg.showAlert) tg.showAlert('–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
                                        else alert('–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
                                    }
                                } catch (err) {
                                    if (tg && tg.showAlert) tg.showAlert('–ë–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ —Å–ø–∏—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥!');
                                    else alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏!');
                                }
                            };

                            if (tg && tg.showConfirm) {
                                tg.showConfirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é "${c.name}"?`, (confirmDelete) => {
                                    if (confirmDelete) executeDelete();
                                });
                            } else {
                                if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é "${c.name}"?`)) {
                                    executeDelete();
                                }
                            }
                        };

                        div.appendChild(infoDiv);
                        div.appendChild(delBtn);
                        comboListDiv.appendChild(div);
                    });
                }
            } catch (e) {
                comboListDiv.innerHTML = '<div style="color: #fca5a5; font-size: 0.9rem; padding:10px;">–ë—ç–∫–µ–Ω–¥ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω. –ñ–¥–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!</div>';
            }
        });

        document.getElementById('confirmSaveBtn').addEventListener('click', async () => {
            const name = comboNameInput.value.trim();
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏!');

            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–∑ Telegram WebApp
            let author = '–¢—Ä–µ–Ω–µ—Ä';
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                author = tg.initDataUnsafe.user.first_name || "–ò–≥—Ä–æ–∫";
            }

            const btn = document.getElementById('confirmSaveBtn');
            btn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            btn.disabled = true;

            const fetchUrl = window.location.protocol === 'file:' ? LOCAL_API_URL : REMOTE_API_URL;

            try {
                const res = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, author, frames })
                });
                const data = await res.json();

                if (data.success) {
                    saveModal.style.display = 'none';
                    comboNameInput.value = '';
                    alert('–ö–æ–º–±–∏–Ω–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É!');
                } else {
                    alert('–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
                }
            } catch (e) {
                alert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –µ—â—ë –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞! –í—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ö–µ–º—ã, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –º—ã –∑–∞–≤–µ—Ä—à–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ—Ä–≤–µ—Ä–∞.');
                saveModal.style.display = 'none';
            } finally {
                btn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                btn.disabled = false;
            }
        });

    </script>
</body>

</html>